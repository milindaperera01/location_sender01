<!DOCTYPE html>
<html>
<head>
  <title>Send & Receive Location on AWS IoT</title>
  <script src="https://sdk.amazonaws.com/js/aws-sdk-2.814.0.min.js"></script>
  <script src="https://cdn.jsdelivr.net/gh/eclipse/paho.mqtt.javascript@v1.1.0/src/paho-mqtt.min.js"></script>
    <script>
    if (typeof Paho === 'undefined') {
        document.getElementById("status").textContent = "‚ùå Paho not loaded.";
    } else {
        console.log("‚úÖ Paho loaded.");
    }
    </script>

  <style>
    body { font-family: Arial, sans-serif; padding: 20px; }
    #status { margin-top: 15px; font-size: 1.1em; }
    #messages { margin-top: 20px; border: 1px solid #ccc; padding: 10px; max-height: 200px; overflow-y: auto; }
    .message { margin-bottom: 8px; padding: 6px; border-bottom: 1px solid #eee; }
  </style>
</head>
<body>
  <h2>üìç Sending & Receiving Messages with AWS IoT</h2>
  <p id="status">Starting...</p>

  <h3>Incoming Messages on <code>mobile/location</code>:</h3>
  <div id="messages">(No messages yet)</div>

  <script>
    const REGION = "us-east-1";
    const IDENTITY_POOL_ID = "us-east-1:018326cf-26a9-4a3e-88e4-d64a4b61bdc2";
    const IOT_ENDPOINT = "a85vmpn2frq7e-ats.iot.us-east-1.amazonaws.com";

    function updateStatus(msg) {
      document.getElementById("status").textContent = msg;
      console.log(msg);
    }

    function addMessage(msg) {
      const container = document.getElementById("messages");
      const div = document.createElement("div");
      div.className = "message";
      div.textContent = msg;
      container.appendChild(div);
      container.scrollTop = container.scrollHeight;
    }

    AWS.config.region = REGION;
    AWS.config.credentials = new AWS.CognitoIdentityCredentials({
      IdentityPoolId: IDENTITY_POOL_ID
    });

    updateStatus("Requesting AWS credentials...");
    AWS.config.credentials.get(function(err) {
      if (err) {
        updateStatus("Error getting AWS credentials: " + err.message || err);
        console.error("Cognito error:", err);
        return;
      }

      updateStatus("AWS credentials obtained.");

      const creds = AWS.config.credentials;
      const clientId = "client-" + Math.floor(Math.random() * 1000000);

      const mqttClient = new Paho.MQTT.Client(
        IOT_ENDPOINT,
        443,
        "/mqtt",
        clientId
      );

      mqttClient.onConnectionLost = function(responseObject) {
        updateStatus("MQTT connection lost: " + (responseObject.errorMessage || "Unknown"));
        console.error("Connection lost:", responseObject);
      };

      mqttClient.onMessageArrived = function(message) {
        const topic = message.destinationName;
        const payload = message.payloadString;
        addMessage(`[${new Date().toLocaleTimeString()}] Topic: ${topic} ‚Äî Message: ${payload}`);
        console.log("Received message:", topic, payload);
      };

      const connectOptions = {
        useSSL: true,
        timeout: 5,
        mqttVersion: 4,
        onSuccess: () => {
          updateStatus("Connected to AWS IoT. Subscribing to topic and sending location...");

          mqttClient.subscribe("mobile/location", {
            qos: 0,
            onSuccess: () => updateStatus("Subscribed to topic mobile/location"),
            onFailure: (err) => updateStatus("Subscribe failed: " + JSON.stringify(err))
          });

          if (!navigator.geolocation) {
            updateStatus("Geolocation is not supported by your browser.");
            return;
          }

          navigator.geolocation.getCurrentPosition(
            (position) => {
              const payload = {
                lat: position.coords.latitude,
                lon: position.coords.longitude,
                time: new Date().toISOString()
              };
              const message = new Paho.MQTT.Message(JSON.stringify(payload));
              message.destinationName = "mobile/location";
              mqttClient.send(message);
              updateStatus("üì§ Location sent to AWS IoT!");
              console.log("Published payload:", payload);
            },
            (geoErr) => {
              updateStatus("Geolocation error: " + geoErr.message);
              console.error("Geolocation error:", geoErr);
            },
            { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
          );
        },
        onFailure: (err) => {
          updateStatus("‚ùå MQTT connection failed: " + JSON.stringify(err));
          console.error("MQTT connection failed:", err);
        },

        // NOTE: Using AWS temporary credentials directly with Paho MQTT won't work without SigV4 signing.
        // This example assumes your AWS IoT policy allows anonymous or unauthenticated connections,
        // or you handle the SigV4 signing externally.
        userName: creds.accessKeyId,
        password: creds.sessionToken
      };

      mqttClient.connect(connectOptions);
    });
  </script>
</body>
</html>
