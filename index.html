<!DOCTYPE html>
<html>
<head>
  <title>Send Location to AWS IoT</title>
  <script src="https://sdk.amazonaws.com/js/aws-sdk-2.814.0.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.1.0/mqttws31.min.js"></script>
</head>
<body>
  <h2>üìç Sending Your Location to AWS IoT</h2>
  <p id="status">Requesting AWS credentials...</p>

  <script>
    const REGION = "us-east-1";
    const IDENTITY_POOL_ID = "us-east-1:018326cf-26a9-4a3e-88e4-d64a4b61bdc2";
    const IOT_ENDPOINT = "a85vmpn2frq7e-ats.iot.us-east-1.amazonaws.com";

    AWS.config.region = REGION;
    AWS.config.credentials = new AWS.CognitoIdentityCredentials({
      IdentityPoolId: IDENTITY_POOL_ID
    });

    AWS.config.credentials.get(function(err) {
      if (err) {
        document.getElementById("status").textContent = "Error getting credentials: " + err;
        console.error(err);
        return;
      }

      const creds = AWS.config.credentials;
      const clientId = "client-" + Math.floor(Math.random() * 1000000);

      const mqttClient = new Paho.MQTT.Client(
        IOT_ENDPOINT,
        443,
        "/mqtt",
        clientId
      );

      const connectOptions = {
        useSSL: true,
        timeout: 3,
        mqttVersion: 4,
        onSuccess: () => {
          document.getElementById("status").textContent = "Connected. Getting location...";
          navigator.geolocation.getCurrentPosition((position) => {
            const payload = {
              lat: position.coords.latitude,
              lon: position.coords.longitude,
              time: new Date().toISOString()
            };

            const message = new Paho.MQTT.Message(JSON.stringify(payload));
            message.destinationName = "mobile/location";
            mqttClient.send(message);
            document.getElementById("status").textContent = "üì§ Location sent to AWS IoT!";
          }, (geoErr) => {
            document.getElementById("status").textContent = "Geolocation error: " + geoErr.message;
          });
        },
        onFailure: (err) => {
          console.error("MQTT connection failed:", err);
          document.getElementById("status").textContent = "‚ùå MQTT connection failed";
        },
        userName: creds.accessKeyId,
        password: creds.sessionToken
      };

      mqttClient.connect(connectOptions);
    });
  </script>
</body>
</html>
