<!DOCTYPE html>
<html>
<head>
  <title>Send & Receive Location on AWS IoT</title>
  <script src="https://sdk.amazonaws.com/js/aws-sdk-2.814.0.min.js"></script>
  <!-- Fixed Paho MQTT client CDN -->
  <script src="https://unpkg.com/paho-mqtt@1.1.0/paho-mqtt.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; }
    #status { margin-top: 15px; font-size: 1.1em; }
    #messages { margin-top: 20px; border: 1px solid #ccc; padding: 10px; max-height: 200px; overflow-y: auto; }
    .message { margin-bottom: 8px; padding: 6px; border-bottom: 1px solid #eee; }
  </style>
</head>
<body>
  <h2>üìç Sending & Receiving Messages with AWS IoT</h2>
  <p id="status">Starting...</p>

  <h3>Incoming Messages on <code>mobile/location</code>:</h3>
  <div id="messages">(No messages yet)</div>

  <script>
    const REGION = "us-east-1";
    const IDENTITY_POOL_ID = "us-east-1:018326cf-26a9-4a3e-88e4-d64a4b61bdc2";
    const IOT_ENDPOINT = "a85vmpn2frq7e-ats.iot.us-east-1.amazonaws.com";

    const statusEl = document.getElementById("status");
    const messagesEl = document.getElementById("messages");

    function updateStatus(msg) {
      statusEl.textContent = msg;
      console.log(msg);
    }

    function addMessage(msg) {
      const div = document.createElement("div");
      div.className = "message";
      div.textContent = msg;
      messagesEl.appendChild(div);
      messagesEl.scrollTop = messagesEl.scrollHeight;
    }

    // SigV4 signer for generating AWS IoT WebSocket URL
    // Source adapted from AWS IoT JS SDK example: https://github.com/aws/aws-iot-device-sdk-js/blob/master/examples/browser/browser-sigv4-utils.js
    const SigV4Utils = {
      sign(key, msg) {
        const hash = CryptoJS.HmacSHA256(msg, key);
        return hash.toString(CryptoJS.enc.Hex);
      },
      sha256(msg) {
        const hash = CryptoJS.SHA256(msg);
        return hash.toString(CryptoJS.enc.Hex);
      },
      getSignatureKey(key, dateStamp, regionName, serviceName) {
        const kDate = CryptoJS.HmacSHA256(dateStamp, "AWS4" + key);
        const kRegion = CryptoJS.HmacSHA256(regionName, kDate);
        const kService = CryptoJS.HmacSHA256(serviceName, kRegion);
        const kSigning = CryptoJS.HmacSHA256("aws4_request", kService);
        return kSigning;
      },
      getSignedUrl(options) {
        // We will NOT do manual signing here because AWS SDK can do it.
        // We'll rely on AWS SDK to sign the request.

        // Instead, we'll build the URL in the connect function below.
        return null;
      }
    };

    // We need CryptoJS for SigV4 signing (load from CDN)
    const cryptoJSScript = document.createElement("script");
    cryptoJSScript.src = "https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js";
    cryptoJSScript.onload = () => initAWSIoT();
    document.head.appendChild(cryptoJSScript);

    function initAWSIoT() {
      AWS.config.region = REGION;
      AWS.config.credentials = new AWS.CognitoIdentityCredentials({
        IdentityPoolId: IDENTITY_POOL_ID
      });

      updateStatus("Requesting AWS credentials...");
      AWS.config.credentials.get(function(err) {
        if (err) {
          updateStatus("Error getting AWS credentials: " + err.message || err);
          console.error("Cognito error:", err);
          return;
        }

        updateStatus("AWS credentials obtained.");

        const creds = AWS.config.credentials;

        // Use AWS SDK to get signed URL for WebSocket MQTT connection
        const request = new AWS.HttpRequest(`wss://${IOT_ENDPOINT}/mqtt`, REGION);

        request.method = 'GET';
        request.headers['host'] = IOT_ENDPOINT;
        request.headers['X-Amz-Date'] = (new Date()).toISOString().replace(/[:\-]|\.\d{3}/g, '');
        request.headers['X-Amz-Security-Token'] = creds.sessionToken;
        request.headers['X-Amz-Expires'] = '15';
        request.headers['X-Amz-Credential'] = `${creds.accessKeyId}/${getCredentialScope()}`;
        request.headers['X-Amz-SignedHeaders'] = 'host';

        // We use AWS.Signers.V4 to sign the request
        const signer = new AWS.Signers.V4(request, 'iotdevicegateway');
        signer.addAuthorization(creds, new Date());

        // Build final URL with query string
        const url = `wss://${IOT_ENDPOINT}/mqtt?${Object.entries(request.headers)
          .filter(([k]) => k.startsWith('X-Amz-'))
          .map(([k,v]) => `${encodeURIComponent(k)}=${encodeURIComponent(v)}`)
          .join('&')}`;

        connectToMQTT(url, creds.sessionToken);
      });
    }

    // Helper to get credential scope string (YYYYMMDD/region/service/aws4_request)
    function getCredentialScope() {
      const date = new Date();
      const yyyyMMdd = date.toISOString().slice(0,10).replace(/-/g, '');
      return `${yyyyMMdd}/${REGION}/iotdevicegateway/aws4_request`;
    }

    function connectToMQTT(signedUrl, sessionToken) {
      const clientId = "client-" + Math.floor(Math.random() * 1000000);

      // Create Paho MQTT client with signed WebSocket URL
      const mqttClient = new Paho.MQTT.Client(
        signedUrl,
        clientId
      );

      mqttClient.onConnectionLost = function(responseObject) {
        updateStatus("MQTT connection lost: " + (responseObject.errorMessage || "Unknown"));
        console.error("Connection lost:", responseObject);
      };

      mqttClient.onMessageArrived = function(message) {
        const topic = message.destinationName;
        const payload = message.payloadString;
        addMessage(`[${new Date().toLocaleTimeString()}] Topic: ${topic} ‚Äî Message: ${payload}`);
        console.log("Received message:", topic, payload);
      };

      const connectOptions = {
        useSSL: true,
        timeout: 5,
        mqttVersion: 4,
        onSuccess: () => {
          updateStatus("Connected to AWS IoT. Subscribing to topic and sending location...");

          // Subscribe to topic to receive messages
          mqttClient.subscribe("mobile/location", {
            qos: 0,
            onSuccess: () => updateStatus("Subscribed to topic mobile/location"),
            onFailure: (err) => updateStatus("Subscribe failed: " + JSON.stringify(err))
          });

          if (!navigator.geolocation) {
            updateStatus("Geolocation is not supported by your browser.");
            return;
          }

          navigator.geolocation.getCurrentPosition(
            (position) => {
              const payload = {
                lat: position.coords.latitude,
                lon: position.coords.longitude,
                time: new Date().toISOString()
              };
              const message = new Paho.MQTT.Message(JSON.stringify(payload));
              message.destinationName = "mobile/location";
              mqttClient.send(message);
              updateStatus("üì§ Location sent to AWS IoT!");
              console.log("Published payload:", payload);
            },
            (geoErr) => {
              updateStatus("Geolocation error: " + geoErr.message);
              console.error("Geolocation error:", geoErr);
            },
            { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
          );
        },
        onFailure: (err) => {
          updateStatus("‚ùå MQTT connection failed: " + JSON.stringify(err));
          console.error("MQTT connection failed:", err);
        },

        // Pass session token as password, per AWS requirements
        userName: 'unused',  // AWS IoT WebSocket requires any non-empty string here
        password: sessionToken
      };

      mqttClient.connect(connectOptions);
    }
  </script>
</body>
</html>
