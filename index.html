<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Send Train Location</title>
  <style>
    body { font-family: sans-serif; text-align: center; margin-top: 50px; }
    #status { margin-top: 20px; color: green; }
    input, button { padding: 8px; font-size: 16px; margin: 5px; }
  </style>
</head>
<body>
  <h2>Send Train Location</h2>
  <input type="text" id="trainNameInput" placeholder="Enter train name" /><br>
  <input type="number" id="speedInput" placeholder="Enter speed (km/h)" /><br><br>
  <button onclick="startSending()">Start Sending Location</button>
  <button onclick="stopSending()">Stop Sending</button>
  <div id="status">Status: Idle</div>

  <script>
    const endpoint = "https://4e589bbf14b2.ngrok-free.app/api/loc/";
    let watchId = null;

    function sendLocationJSON(train_name, speed, lat, lon) {
      const data = { train_name, speed, latitude: lat, longitude: lon };
      fetch(endpoint, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(data)
      })
      .then(response => {
        if (response.ok) {
          document.getElementById("status").innerText = `Location sent successfully at ${new Date().toLocaleTimeString()}.`;
        } else {
          document.getElementById("status").innerText = "Failed to send location: " + response.statusText;
        }
      })
      .catch(error => {
        document.getElementById("status").innerText = "Error sending location: " + error.message;
      });
    }

    function startSending() {
      const train_name = document.getElementById("trainNameInput").value.trim();
      const speed = document.getElementById("speedInput").value.trim();

      if (!train_name || !speed) {
        document.getElementById("status").innerText = "Please enter both train name and speed.";
        return;
      }

      if (!("geolocation" in navigator)) {
        document.getElementById("status").innerText = "Geolocation is not supported by this browser.";
        return;
      }

      document.getElementById("status").innerText = "Started sending location (watching position).";

      if (watchId !== null) {
        navigator.geolocation.clearWatch(watchId);
      }

      watchId = navigator.geolocation.watchPosition(
        (position) => {
          const lat = position.coords.latitude;
          const lon = position.coords.longitude;
          sendLocationJSON(train_name, speed, lat, lon);
        },
        (error) => {
          document.getElementById("status").innerText = "Error getting location: " + error.message;
        },
        {
          enableHighAccuracy: true,
          maximumAge: 0,
          timeout: 10000
        }
      );
    }

    function stopSending() {
      if (watchId !== null) {
        navigator.geolocation.clearWatch(watchId);
        watchId = null;
        document.getElementById("status").innerText = "Stopped sending location.";
      }
    }
  </script>
</body>
</html>
